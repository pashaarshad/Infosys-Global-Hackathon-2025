{% extends "base-ultra.html" %}

{% block title %}Nearby Recyclers - SmartRecycle{% endblock %}

{% block content %}
<!-- Animated Back Arrow -->
<div class="back-arrow" onclick="goHome()">
    <i class="fas fa-arrow-left"></i>
    <span>Return to Home</span>
</div>

<!-- Hero Section -->
<section class="hero-ultra">
    <div class="hero-content-ultra">
        <div class="hero-animation">
            <div class="floating-icons">
                <div class="icon-float icon-1">üìç</div>
                <div class="icon-float icon-2">üó∫Ô∏è</div>
                <div class="icon-float icon-3">‚ôªÔ∏è</div>
                <div class="icon-float icon-4">üè≠</div>
            </div>
        </div>
        <div class="hero-text-ultra" data-aos="fade-up">
            <h1 class="gradient-text">üìç Nearby Recyclers</h1>
            <p class="hero-subtitle">Find certified recycling centers and drop-off points near you</p>
            <div class="hero-features">
                <div class="feature-item" data-aos="fade-up" data-aos-delay="200">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>Real-time locations</span>
                </div>
                <div class="feature-item" data-aos="fade-up" data-aos-delay="300">
                    <i class="fas fa-route"></i>
                    <span>Turn-by-turn directions</span>
                </div>
                <div class="feature-item" data-aos="fade-up" data-aos-delay="400">
                    <i class="fas fa-star"></i>
                    <span>Verified & rated centers</span>
                </div>
            </div>
        </div>
    </div>
    <div class="wave-animation">
        <svg viewBox="0 0 1200 120" preserveAspectRatio="none">
            <path d="M0,0V46.29c47.79,22.2,103.59,32.17,158,28,70.36-5.37,136.33-33.31,206.8-37.5C438.64,32.43,512.34,53.67,583,72.05c69.27,18,138.3,24.88,209.4,13.08,36.15-6,69.85-17.84,104.45-29.34C989.49,25,1113-14.29,1200,52.47V0Z" opacity=".25" class="shape-fill"></path>
            <path d="M0,0V15.81C13,36.92,27.64,56.86,47.69,72.05,99.41,111.27,165,111,224.58,91.58c31.15-10.15,60.09-26.07,89.67-39.8,40.92-19,84.73-46,130.83-49.67,36.26-2.85,70.9,9.42,98.6,31.56,31.77,25.39,62.32,62,103.63,73,40.44,10.79,81.35-6.69,119.13-24.28s75.16-39,116.92-43.05c59.73-5.85,113.28,22.88,168.9,38.84,30.2,8.66,59,6.17,87.09-7.5,22.43-10.89,48-26.93,60.65-49.24V0Z" opacity=".5" class="shape-fill"></path>
            <path d="M0,0V5.63C149.93,59,314.09,71.32,475.83,42.57c43-7.64,84.23-20.12,127.61-26.46,59-8.63,112.48,12.24,165.56,35.4C827.93,77.22,886,95.24,951.2,90c86.53-7,172.46-45.71,248.8-84.81V0Z" class="shape-fill"></path>
        </svg>
    </div>
</section>

<!-- Interactive Map Section -->
<section class="section-ultra">
    <div class="container-ultra">
        <div class="section-header" data-aos="fade-up">
            <h2 class="section-title">üó∫Ô∏è Interactive Map</h2>
            <p class="section-subtitle">Explore recycling centers in your area with our smart map</p>
        </div>
        
        <div class="map-container-ultra" data-aos="fade-up" data-aos-delay="200">
            <div id="recyclerMap" class="map-ultra">
                <div class="map-placeholder">
                    <div class="map-loading">
                        <div class="loading-spinner"></div>
                        <h3>üó∫Ô∏è Loading Interactive Map...</h3>
                        <p>Finding certified recycling centers near you</p>
                    </div>
                </div>
            </div>
            
            <!-- Map Controls -->
            <div class="map-controls-ultra">
                <button onclick="getCurrentLocation()" class="control-btn-ultra location-btn">
                    <i class="fas fa-crosshairs"></i>
                    <span>Find My Location</span>
                </button>
                
                <div class="filter-group">
                    <select id="wasteTypeFilter" class="control-select-ultra" onchange="filterRecyclers()">
                        <option value="all">All Recyclers</option>
                        <option value="plastic">ü•§ Plastic Recyclers</option>
                        <option value="paper">üìÑ Paper & Cardboard</option>
                        <option value="glass">üçæ Glass Recyclers</option>
                        <option value="metal">üî© Metal Recyclers</option>
                        <option value="ewaste">üì± E-Waste Centers</option>
                        <option value="organic">üå± Organic Waste</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <select id="distanceFilter" class="control-select-ultra" onchange="filterByDistance()">
                        <option value="5">Within 5 km</option>
                        <option value="10" selected>Within 10 km</option>
                        <option value="20">Within 20 km</option>
                        <option value="50">Within 50 km</option>
                    </select>
                </div>
                
                <button onclick="refreshMap()" class="control-btn-ultra refresh-btn">
                    <i class="fas fa-sync-alt"></i>
                    <span>Refresh</span>
                </button>
            </div>
        </div>
    </div>
</section>

<!-- Advanced Search and Filter -->
<section class="section-ultra section-alt">
    <div class="container-ultra">
        <div class="section-header" data-aos="fade-up">
            <h2 class="section-title">üîç Smart Search</h2>
            <p class="section-subtitle">Find exactly what you need with our advanced filtering system</p>
        </div>
        
        <div class="search-container-ultra" data-aos="fade-up" data-aos-delay="200">
            <div class="search-box-ultra">
                <div class="search-input-group">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="locationSearch" class="search-input-ultra" 
                           placeholder="Enter area, pincode, or landmark..." 
                           onkeypress="handleSearchKeypress(event)">
                    <button onclick="searchByLocation()" class="search-btn-ultra">
                        <i class="fas fa-search"></i>
                        <span>Search</span>
                    </button>
                </div>
            </div>
            
            <div class="filters-grid-ultra">
                <div class="filter-group-ultra">
                    <label class="filter-label">
                        <i class="fas fa-route"></i>
                        Distance Range
                    </label>
                    <select id="distanceRange" class="filter-select-ultra">
                        <option value="2">Within 2 km</option>
                        <option value="5">Within 5 km</option>
                        <option value="10" selected>Within 10 km</option>
                        <option value="20">Within 20 km</option>
                        <option value="50">Within 50 km</option>
                    </select>
                </div>
                
                <div class="filter-group-ultra">
                    <label class="filter-label">
                        <i class="fas fa-star"></i>
                        Minimum Rating
                    </label>
                    <select id="ratingFilter" class="filter-select-ultra">
                        <option value="0">Any Rating</option>
                        <option value="3">3+ Stars</option>
                        <option value="4" selected>4+ Stars</option>
                        <option value="4.5">4.5+ Stars</option>
                    </select>
                </div>
                
                <div class="filter-group-ultra">
                    <label class="filter-label">
                        <i class="fas fa-clock"></i>
                        Operating Hours
                    </label>
                    <select id="timingFilter" class="filter-select-ultra">
                        <option value="all">Any Time</option>
                        <option value="24hrs">24/7 Available</option>
                        <option value="weekdays">Weekdays Only</option>
                        <option value="weekends">Weekends Available</option>
                    </select>
                </div>
                
                <div class="filter-group-ultra">
                    <label class="filter-label">
                        <i class="fas fa-certificate"></i>
                        Certification
                    </label>
                    <select id="certificationFilter" class="filter-select-ultra">
                        <option value="all">All Centers</option>
                        <option value="certified">Certified Only</option>
                        <option value="government">Government Approved</option>
                        <option value="private">Private Facilities</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Recycler Directory -->
<section class="section-ultra">
    <div class="container-ultra">
        <div class="section-header" data-aos="fade-up">
            <h2 class="section-title">üìã Recycling Centers Directory</h2>
            <p class="section-subtitle">Comprehensive list of verified recycling facilities</p>
        </div>
        
        <div class="recycler-grid-ultra" id="recyclerList" data-aos="fade-up" data-aos-delay="200">
            <!-- Sample recycler cards -->
            <div class="recycler-card-ultra featured" data-aos="zoom-in" data-aos-delay="300">
                <div class="recycler-badge">Featured</div>
                <div class="recycler-header">
                    <h3>EcoGreen Recycling Center</h3>
                    <div class="recycler-rating">
                        <span class="stars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span>
                        <span class="rating-text">4.8 (142 reviews)</span>
                    </div>
                </div>
                <div class="recycler-info">
                    <p><i class="fas fa-map-marker-alt"></i> Electronic City, Bangalore</p>
                    <p><i class="fas fa-clock"></i> Mon-Sat: 9AM-6PM</p>
                    <p><i class="fas fa-phone"></i> +91 9876543210</p>
                    <div class="waste-types">
                        <span class="waste-tag">Plastic</span>
                        <span class="waste-tag">Paper</span>
                        <span class="waste-tag">E-waste</span>
                    </div>
                    <div class="recycler-actions">
                        <button class="btn-action">üìç Get Directions</button>
                        <button class="btn-action">üìû Call Now</button>
                    </div>
                </div>
            </div>
            
            <div class="recycler-card-ultra" data-aos="zoom-in" data-aos-delay="400">
                <div class="recycler-header">
                    <h3>Green Earth Collection</h3>
                    <div class="recycler-rating">
                        <span class="stars">‚≠ê‚≠ê‚≠ê‚≠ê</span>
                        <span class="rating-text">4.2 (89 reviews)</span>
                    </div>
                </div>
                <div class="recycler-info">
                    <p><i class="fas fa-map-marker-alt"></i> Koramangala, Bangalore</p>
                    <p><i class="fas fa-clock"></i> Mon-Fri: 8AM-5PM</p>
                    <p><i class="fas fa-phone"></i> +91 9876543211</p>
                    <div class="waste-types">
                        <span class="waste-tag">Glass</span>
                        <span class="waste-tag">Metal</span>
                        <span class="waste-tag">Paper</span>
                    </div>
                    <div class="recycler-actions">
                        <button class="btn-action">üìç Get Directions</button>
                        <button class="btn-action">üìû Call Now</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Information & Tips -->
<section class="section-ultra section-alt">
    <div class="container-ultra">
        <div class="section-header" data-aos="fade-up">
            <h2 class="section-title">üí° Recycling Tips & Guidelines</h2>
            <p class="section-subtitle">Make the most of your recycling efforts</p>
        </div>
        
        <div class="tips-grid" data-aos="fade-up" data-aos-delay="200">
            <div class="tip-card">
                <div class="tip-icon">üßΩ</div>
                <h4>Clean Before You Bring</h4>
                <p>Rinse containers and remove labels to ensure better recycling rates</p>
            </div>
            <div class="tip-card">
                <div class="tip-icon">üìã</div>
                <h4>Check Accepted Materials</h4>
                <p>Call ahead to confirm what materials each facility accepts</p>
            </div>
            <div class="tip-card">
                <div class="tip-icon">‚è∞</div>
                <h4>Plan Your Visit</h4>
                <p>Check operating hours and plan your route to visit multiple centers</p>
            </div>
            <div class="tip-card">
                <div class="tip-icon">üí∞</div>
                <h4>Know the Rates</h4>
                <p>Some centers pay for materials - compare rates for best value</p>
            </div>
        </div>
    </div>
</section>

{% endblock %}

{% block extra_scripts %}
<script>
function goHome() {
    window.location.href = '/';
}

function getCurrentLocation() {
    showMessage('üìç Getting your location...', 'info');
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            position => {
                showMessage('‚úÖ Location found! Updating map...', 'success');
                // Here you would update the map with user's location
            },
            error => {
                showMessage('‚ùå Unable to get location. Please enable location services.', 'error');
            }
        );
    } else {
        showMessage('‚ùå Geolocation is not supported by this browser.', 'error');
    }
}

function filterRecyclers() {
    const wasteType = document.getElementById('wasteTypeFilter').value;
    showMessage(`üîç Filtering by ${wasteType === 'all' ? 'all recyclers' : wasteType}`, 'info');
    // Here you would implement the actual filtering logic
}

function filterByDistance() {
    const distance = document.getElementById('distanceFilter').value;
    showMessage(`üìè Showing recyclers within ${distance} km`, 'info');
    // Here you would implement the actual distance filtering
}

function refreshMap() {
    showMessage('üîÑ Refreshing map data...', 'info');
    // Here you would refresh the map and recycler data
}

function searchByLocation() {
    const searchInput = document.getElementById('locationSearch');
    const location = searchInput.value.trim();
    
    if (!location) {
        showMessage('Please enter a location to search', 'warning');
        return;
    }
    
    showMessage(`üîç Searching for recyclers near "${location}"...`, 'info');
    // Here you would implement the location search
}

function handleSearchKeypress(event) {
    if (event.key === 'Enter') {
        searchByLocation();
    }
}

function showMessage(message, type) {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 1000;
        padding: 1rem 1.5rem; border-radius: 8px; color: white;
        background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#F44336' : type === 'warning' ? '#FF9800' : '#2196F3'};
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideIn 0.3s ease;
    `;
    notification.innerHTML = `
        ${message}
        <button onclick="this.parentElement.remove()" style="background:none;border:none;color:white;margin-left:1rem;cursor:pointer;">√ó</button>
    `;
    
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 5000);
}

// Add CSS for the missing elements
const style = document.createElement('style');
style.textContent = `
@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.recycler-card-ultra {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    margin: 1rem 0;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}

.recycler-card-ultra:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.recycler-badge {
    background: #4CAF50;
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.8rem;
    display: inline-block;
    margin-bottom: 1rem;
}

.recycler-header h3 {
    margin: 0.5rem 0;
    color: #2E7D32;
}

.recycler-rating {
    margin: 0.5rem 0;
}

.rating-text {
    color: #666;
    font-size: 0.9rem;
    margin-left: 0.5rem;
}

.recycler-info p {
    margin: 0.5rem 0;
    color: #666;
}

.recycler-info i {
    width: 16px;
    margin-right: 0.5rem;
    color: #4CAF50;
}

.waste-types {
    margin: 1rem 0;
}

.waste-tag {
    background: #E8F5E8;
    color: #2E7D32;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.8rem;
    margin-right: 0.5rem;
    border: 1px solid #4CAF50;
}

.recycler-actions {
    margin-top: 1rem;
    display: flex;
    gap: 0.5rem;
}

.btn-action {
    background: #4CAF50;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.3s ease;
}

.btn-action:hover {
    background: #2E7D32;
    transform: translateY(-2px);
}

.tips-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin: 2rem 0;
}

.tip-card {
    background: white;
    padding: 1.5rem;
    border-radius: 15px;
    text-align: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.tip-icon {
    font-size: 2.5rem;
    margin-bottom: 1rem;
}
`;
document.head.appendChild(style);
</script>
{% endblock %}
            <div class="tip-card-ultra" data-aos="flip-left" data-aos-delay="400">
                <div class="tip-icon">üßπ</div>
                <h4>Clean Materials</h4>
                <p>Rinse containers, remove labels and food residue for better acceptance rates</p>
                <div class="tip-benefit">Higher acceptance rates</div>
            </div>
            
            <div class="tip-card-ultra" data-aos="flip-left" data-aos-delay="500">
                <div class="tip-icon">üì¶</div>
                <h4>Separate Items</h4>
                <p>Sort by material type in different bags or containers for faster processing</p>
                <div class="tip-benefit">Faster processing</div>
            </div>
            
            <div class="tip-card-ultra" data-aos="flip-left" data-aos-delay="600">
                <div class="tip-icon">üÜî</div>
                <h4>Bring ID</h4>
                <p>Some centers require identification for certain waste types or valuable materials</p>
                <div class="tip-benefit">Required for some items</div>
            </div>
            
            <div class="tip-card-ultra" data-aos="flip-left" data-aos-delay="700">
                <div class="tip-icon">üí∞</div>
                <h4>Check Payments</h4>
                <p>Some valuable materials may offer payment, certificates, or green points</p>
                <div class="tip-benefit">Potential rewards</div>
            </div>
            
            <div class="tip-card-ultra" data-aos="flip-left" data-aos-delay="800">
                <div class="tip-icon">‚è∞</div>
                <h4>Avoid Peak Hours</h4>
                <p>Visit during off-peak times (mid-morning or early afternoon) for faster service</p>
                <div class="tip-benefit">Shorter wait times</div>
            </div>
        </div>
    </div>
</section>

<!-- Call to Action -->
<section class="cta-section-ultra">
    <div class="container-ultra">
        <div class="cta-content-ultra" data-aos="zoom-in">
            <div class="cta-animation">
                <div class="floating-elements">
                    <div class="element element-1">üåç</div>
                    <div class="element element-2">‚ôªÔ∏è</div>
                    <div class="element element-3">üè≠</div>
                    <div class="element element-4">üöõ</div>
                </div>
            </div>
            <h2>üåç Make a Local Impact!</h2>
            <p>Every trip to a recycling center makes a real difference in your community and the environment. Start your eco-journey today!</p>
            <div class="cta-buttons-ultra">
                <a href="{{ url_for('waste_guide') }}" class="btn-ultra btn-primary-ultra" data-aos="fade-up" data-aos-delay="200">
                    <i class="fas fa-question-circle"></i>
                    <span>Check What to Recycle</span>
                </a>
                <a href="{{ url_for('request_pickup') }}" class="btn-ultra btn-secondary-ultra" data-aos="fade-up" data-aos-delay="300">
                    <i class="fas fa-truck"></i>
                    <span>Schedule Pickup Instead</span>
                </a>
                <button onclick="downloadMap()" class="btn-ultra btn-accent-ultra" data-aos="fade-up" data-aos-delay="400">
                    <i class="fas fa-download"></i>
                    <span>Download Map</span>
                </button>
            </div>
        </div>
    </div>
</section>

<!-- Recycler Detail Modal -->
<div id="recyclerModal" class="modal-ultra" onclick="closeRecyclerModal()">
    <div class="modal-content-ultra recycler-modal" onclick="event.stopPropagation()">
        <div class="modal-header-ultra">
            <h3 id="recyclerModalTitle">Recycler Details</h3>
            <button class="modal-close-ultra" onclick="closeRecyclerModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body-ultra" id="recyclerModalBody">
            <!-- Content will be populated dynamically -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Enhanced Nearby Recyclers Page Functions

// Back to home navigation
function goHome() {
    document.body.style.animation = 'fadeOut 0.3s ease';
    setTimeout(() => {
        window.location.href = "{{ url_for('home') }}";
    }, 300);
}

// Sample recycler data (in production, this would come from API/database)
const recyclerData = [
    {
        id: 'eco-recycle',
        name: 'EcoRecycle Industries',
        address: 'Electronic City, Bangalore',
        phone: '+91 9876543210',
        email: 'info@ecorecycle.com',
        distance: 2.3,
        rating: 4.8,
        specialties: ['Plastic', 'Paper', 'E-Waste'],
        hours: 'Mon-Sat: 8 AM - 6 PM',
        certified: true,
        features: ['Government Certified', 'ISO 14001', 'Data Destruction', 'Pickup Service'],
        description: 'Leading recycling facility with state-of-the-art processing equipment and environmental certifications.',
        coordinates: { lat: 12.8456, lng: 77.6603 }
    },
    {
        id: 'green-valley',
        name: 'Green Valley Recyclers',
        address: 'Koramangala, Bangalore',
        phone: '+91 8765432109',
        email: 'contact@greenvalley.com',
        distance: 3.7,
        rating: 4.6,
        specialties: ['Glass', 'Metal', 'Organic'],
        hours: '24/7 Available',
        certified: true,
        features: ['24/7 Drop-off', 'Composting Facility', 'Metal Recovery', 'Cash for Metals'],
        description: 'Community-focused recycling center with round-the-clock drop-off facility.',
        coordinates: { lat: 12.9352, lng: 77.6245 }
    },
    {
        id: 'techworks',
        name: 'TechWaste Solutions',
        address: 'HSR Layout, Bangalore',
        phone: '+91 7654321098',
        email: 'support@techworks.com',
        distance: 4.1,
        rating: 4.9,
        specialties: ['E-Waste', 'Batteries', 'Electronics'],
        hours: 'Mon-Fri: 9 AM - 5 PM',
        certified: true,
        features: ['Certified E-Waste', 'Data Security', 'Corporate Pickup', 'Certificate Provided'],
        description: 'Specialized e-waste processing with certified data destruction and secure recycling.',
        coordinates: { lat: 12.9116, lng: 77.6473 }
    }
];

// Initialize map placeholder
function initializeMapPlaceholder() {
    const mapContainer = document.getElementById('recyclerMap');
    if (mapContainer) {
        mapContainer.innerHTML = `
            <div class="map-placeholder">
                <div class="map-loading">
                    <div class="loading-spinner"></div>
                    <h3>üó∫Ô∏è Interactive Map</h3>
                    <p>Showing recycling centers in your area</p>
                    <div class="map-features">
                        <span class="feature-tag">üìç Real-time locations</span>
                        <span class="feature-tag">üöó Turn-by-turn directions</span>
                        <span class="feature-tag">‚≠ê Verified centers</span>
                    </div>
                </div>
            </div>
        `;
        
        // Simulate map loading
        setTimeout(() => {
            if (mapContainer.querySelector('.map-loading')) {
                mapContainer.innerHTML = `
                    <div class="map-interactive">
                        <div class="map-overlay">
                            <h3>üìç Interactive Map Ready</h3>
                            <p>Click on markers to view recycler details</p>
                            <button onclick="simulateMapInteraction()" class="map-demo-btn">
                                <i class="fas fa-play"></i> Demo Map Features
                            </button>
                        </div>
                    </div>
                `;
            }
        }, 2000);
    }
}

// Get current location
function getCurrentLocation() {
    showMessage('üîç Getting your current location...', 'info');
    
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const userLat = position.coords.latitude;
                const userLng = position.coords.longitude;
                
                showMessage('üìç Location found! Updating nearby centers...', 'success');
                
                // Update distances based on user location
                updateRecyclerDistances(userLat, userLng);
                
                // Refresh the recycler list
                setTimeout(() => {
                    populateRecyclerList();
                    showMessage('‚úÖ Recycler list updated with your location!', 'success');
                }, 1000);
            },
            (error) => {
                let errorMsg = '‚ùå Unable to get location. ';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMsg += 'Location access denied by user.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMsg += 'Location information unavailable.';
                        break;
                    case error.TIMEOUT:
                        errorMsg += 'Location request timed out.';
                        break;
                    default:
                        errorMsg += 'Unknown error occurred.';
                        break;
                }
                showMessage(errorMsg, 'warning');
            }
        );
    } else {
        showMessage('‚ùå Geolocation is not supported by this browser.', 'error');
    }
}

// Calculate distance between two coordinates
function calculateDistance(lat1, lng1, lat2, lng2) {
    const R = 6371; // Earth's radius in km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLng/2) * Math.sin(dLng/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

// Update recycler distances
function updateRecyclerDistances(userLat, userLng) {
    recyclerData.forEach(recycler => {
        const distance = calculateDistance(
            userLat, userLng,
            recycler.coordinates.lat, recycler.coordinates.lng
        );
        recycler.distance = Math.round(distance * 10) / 10;
    });
    
    // Sort by distance
    recyclerData.sort((a, b) => a.distance - b.distance);
}

// Filter recyclers based on selected criteria
function filterRecyclers() {
    const wasteType = document.getElementById('wasteTypeFilter')?.value || 'all';
    const distance = parseInt(document.getElementById('distanceFilter')?.value || '10');
    const rating = parseFloat(document.getElementById('ratingFilter')?.value || '0');
    
    let filtered = recyclerData.filter(recycler => {
        const typeMatch = wasteType === 'all' || 
                         recycler.specialties.some(s => s.toLowerCase().includes(wasteType.toLowerCase()));
        const distanceMatch = recycler.distance <= distance;
        const ratingMatch = recycler.rating >= rating;
        
        return typeMatch && distanceMatch && ratingMatch;
    });
    
    populateRecyclerList(filtered);
    
    showMessage(`Found ${filtered.length} recycling centers matching your criteria.`, 'info');
}

// Filter by distance
function filterByDistance() {
    filterRecyclers();
}

// Search by location
function searchByLocation() {
    const searchInput = document.getElementById('locationSearch');
    const location = searchInput?.value.trim();
    
    if (!location) {
        showMessage('Please enter a location to search.', 'warning');
        return;
    }
    
    showMessage(`üîç Searching for recyclers near "${location}"...`, 'info');
    
    // Simulate search delay
    setTimeout(() => {
        showMessage(`üìç Found recyclers near ${location}!`, 'success');
        populateRecyclerList();
    }, 1500);
}

// Handle search input keypress
function handleSearchKeypress(event) {
    if (event.key === 'Enter') {
        searchByLocation();
    }
}

// Populate recycler list
function populateRecyclerList(data = recyclerData) {
    const container = document.getElementById('recyclerList');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (data.length === 0) {
        container.innerHTML = `
            <div class="no-results">
                <i class="fas fa-search"></i>
                <h3>No recyclers found</h3>
                <p>Try adjusting your filters or expanding the search distance.</p>
                <button onclick="resetFilters()" class="btn-ultra btn-primary-ultra">
                    <i class="fas fa-refresh"></i>
                    Reset Filters
                </button>
            </div>
        `;
        return;
    }
    
    data.forEach((recycler, index) => {
        const card = createRecyclerCard(recycler, index);
        container.appendChild(card);
    });
}

// Create recycler card element
function createRecyclerCard(recycler, index) {
    const card = document.createElement('div');
    card.className = 'recycler-card-ultra';
    if (index === 0) card.classList.add('featured');
    
    const specialtyTags = recycler.specialties.map(specialty => 
        `<span class="specialty-tag ${specialty.toLowerCase()}">${specialty}</span>`
    ).join('');
    
    const stars = '‚òÖ'.repeat(Math.floor(recycler.rating)) + 
                  (recycler.rating % 1 >= 0.5 ? '‚òÜ' : '');
    
    card.innerHTML = `
        ${index === 0 ? '<div class="recycler-badge">Featured</div>' : ''}
        <div class="recycler-header">
            <div class="recycler-icon">
                <i class="fas fa-${getRecyclerIcon(recycler.specialties[0])}"></i>
            </div>
            <div class="recycler-rating">
                <span class="rating-value">${recycler.rating}</span>
                <div class="rating-stars">${stars}</div>
            </div>
        </div>
        <div class="recycler-info">
            <h3>${recycler.name}</h3>
            <p class="recycler-location">
                <i class="fas fa-map-marker-alt"></i>
                ${recycler.address} - ${recycler.distance} km away
            </p>
            <div class="recycler-specialties">
                ${specialtyTags}
                ${recycler.certified ? '<span class="specialty-tag certified">Certified</span>' : ''}
            </div>
            <div class="recycler-details">
                <div class="detail-item">
                    <i class="fas fa-clock"></i>
                    <span>${recycler.hours}</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-phone"></i>
                    <span>${recycler.phone}</span>
                </div>
            </div>
        </div>
        <div class="recycler-actions">
            <button onclick="getDirections('${recycler.name}')" class="action-btn primary">
                <i class="fas fa-route"></i>
                Get Directions
            </button>
            <button onclick="showRecyclerDetails('${recycler.id}')" class="action-btn secondary">
                <i class="fas fa-info-circle"></i>
                Details
            </button>
        </div>
    `;
    
    return card;
}

// Get appropriate icon for recycler type
function getRecyclerIcon(specialty) {
    const icons = {
        'Plastic': 'recycle',
        'Paper': 'newspaper',
        'Glass': 'wine-bottle',
        'Metal': 'tools',
        'E-Waste': 'laptop',
        'Electronics': 'mobile-alt',
        'Organic': 'seedling',
        'Batteries': 'battery-full'
    };
    return icons[specialty] || 'industry';
}

// Show recycler details modal
function showRecyclerDetails(recyclerId) {
    const recycler = recyclerData.find(r => r.id === recyclerId);
    if (!recycler) return;
    
    const modal = document.getElementById('recyclerModal');
    const title = document.getElementById('recyclerModalTitle');
    const body = document.getElementById('recyclerModalBody');
    
    title.textContent = recycler.name;
    
    body.innerHTML = `
        <div class="recycler-detail-content">
            <div class="detail-header">
                <div class="detail-rating">
                    <span class="rating-value">${recycler.rating}</span>
                    <div class="rating-stars">${'‚òÖ'.repeat(Math.floor(recycler.rating))}</div>
                    <span class="rating-text">Excellent Rating</span>
                </div>
                <div class="detail-distance">
                    <i class="fas fa-route"></i>
                    <span>${recycler.distance} km away</span>
                </div>
            </div>
            
            <div class="detail-section">
                <h4><i class="fas fa-map-marker-alt"></i> Location & Contact</h4>
                <p><strong>Address:</strong> ${recycler.address}</p>
                <p><strong>Phone:</strong> ${recycler.phone}</p>
                <p><strong>Email:</strong> ${recycler.email}</p>
                <p><strong>Hours:</strong> ${recycler.hours}</p>
            </div>
            
            <div class="detail-section">
                <h4><i class="fas fa-recycle"></i> Accepted Materials</h4>
                <div class="specialties-detail">
                    ${recycler.specialties.map(s => `<span class="specialty-badge">${s}</span>`).join('')}
                </div>
            </div>
            
            <div class="detail-section">
                <h4><i class="fas fa-certificate"></i> Features & Certifications</h4>
                <ul class="features-list">
                    ${recycler.features.map(f => `<li><i class="fas fa-check"></i> ${f}</li>`).join('')}
                </ul>
            </div>
            
            <div class="detail-section">
                <h4><i class="fas fa-info-circle"></i> About</h4>
                <p>${recycler.description}</p>
            </div>
            
            <div class="detail-actions">
                <button onclick="getDirections('${recycler.name}')" class="btn-ultra btn-primary-ultra">
                    <i class="fas fa-route"></i> Get Directions
                </button>
                <button onclick="callRecycler('${recycler.phone}')" class="btn-ultra btn-secondary-ultra">
                    <i class="fas fa-phone"></i> Call Now
                </button>
                <button onclick="schedulePickup('${recycler.id}')" class="btn-ultra btn-accent-ultra">
                    <i class="fas fa-truck"></i> Schedule Pickup
                </button>
            </div>
        </div>
    `;
    
    modal.style.display = 'flex';
    setTimeout(() => {
        modal.querySelector('.modal-content-ultra').style.transform = 'scale(1)';
        modal.querySelector('.modal-content-ultra').style.opacity = '1';
    }, 10);
}

// Close recycler details modal
function closeRecyclerModal() {
    const modal = document.getElementById('recyclerModal');
    const content = modal.querySelector('.modal-content-ultra');
    
    content.style.transform = 'scale(0.9)';
    content.style.opacity = '0';
    
    setTimeout(() => {
        modal.style.display = 'none';
    }, 300);
}

// Get directions to recycler
function getDirections(recyclerName) {
    showMessage(`üß≠ Opening directions to ${recyclerName}...`, 'info');
    
    // In a real app, this would open Google Maps or similar
    setTimeout(() => {
        showMessage('üì± Directions opened in your default maps app!', 'success');
        // window.open(`https://www.google.com/maps/search/${encodeURIComponent(recyclerName)}`, '_blank');
    }, 1000);
}

// Call recycler
function callRecycler(phone) {
    showMessage(`üìû Calling ${phone}...`, 'info');
    // window.open(`tel:${phone}`, '_self');
}

// Emergency contact functions
function callEmergency(phone) {
    showMessage(`üö® Calling emergency line ${phone}...`, 'info');
    // window.open(`tel:${phone}`, '_self');
}

function emailEmergency(email) {
    showMessage(`üìß Opening email to ${email}...`, 'info');
    // window.open(`mailto:${email}`, '_self');
}

// Load more recyclers
function loadMoreRecyclers() {
    showMessage('üîÑ Loading more recycling centers...', 'info');
    
    setTimeout(() => {
        showMessage('‚úÖ More centers loaded!', 'success');
        // In real app, this would load more data from API
    }, 1500);
}

// Download map
function downloadMap() {
    showMessage('üìÑ Generating downloadable map...', 'info');
    
    setTimeout(() => {
        showMessage('üì± Map downloaded! Check your downloads folder.', 'success');
        // In real app, this would generate and download a PDF map
    }, 2000);
}

// Schedule pickup from specific recycler
function schedulePickup(recyclerId) {
    showMessage('üìÖ Redirecting to pickup scheduling...', 'info');
    
    setTimeout(() => {
        window.location.href = "{{ url_for('request_pickup') }}";
    }, 1000);
}

// Refresh map
function refreshMap() {
    showMessage('üîÑ Refreshing map data...', 'info');
    
    setTimeout(() => {
        initializeMapPlaceholder();
        populateRecyclerList();
        showMessage('‚úÖ Map refreshed successfully!', 'success');
    }, 1500);
}

// Reset all filters
function resetFilters() {
    const filters = ['wasteTypeFilter', 'distanceFilter', 'ratingFilter', 'timingFilter', 'certificationFilter'];
    filters.forEach(filterId => {
        const element = document.getElementById(filterId);
        if (element) {
            element.value = element.querySelector('option[selected]')?.value || element.options[0].value;
        }
    });
    
    const searchInput = document.getElementById('locationSearch');
    if (searchInput) searchInput.value = '';
    
    populateRecyclerList();
    showMessage('üîÑ Filters reset to default values.', 'info');
}

// Simulate map interaction
function simulateMapInteraction() {
    showMessage('üó∫Ô∏è Map interaction demo...', 'info');
    
    const mapContainer = document.getElementById('recyclerMap');
    if (mapContainer) {
        mapContainer.innerHTML = `
            <div class="map-demo">
                <div class="demo-marker marker-1">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>EcoRecycle Industries</span>
                </div>
                <div class="demo-marker marker-2">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>Green Valley</span>
                </div>
                <div class="demo-marker marker-3">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>TechWaste Solutions</span>
                </div>
                <div class="demo-user-location">
                    <i class="fas fa-circle"></i>
                    <span>Your Location</span>
                </div>
            </div>
        `;
    }
    
    setTimeout(() => {
        showMessage('‚ú® Map features demonstrated! In the full version, you can click markers for details.', 'success');
    }, 2000);
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Initialize AOS
    if (typeof AOS !== 'undefined') {
        AOS.init({
            duration: 800,
            once: true,
            offset: 100
        });
    }
    
    // Initialize map placeholder
    initializeMapPlaceholder();
    
    // Populate initial recycler list
    populateRecyclerList();
    
    // Set up event listeners
    const searchInput = document.getElementById('locationSearch');
    if (searchInput) {
        searchInput.addEventListener('keypress', handleSearchKeypress);
    }
    
    // Set up filter event listeners
    const filters = ['wasteTypeFilter', 'distanceRange', 'ratingFilter', 'timingFilter', 'certificationFilter'];
    filters.forEach(filterId => {
        const element = document.getElementById(filterId);
        if (element) {
            element.addEventListener('change', filterRecyclers);
        }
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeRecyclerModal();
        }
        if (e.key === 'h' && e.ctrlKey) {
            e.preventDefault();
            goHome();
        }
        if (e.key === 'f' && e.ctrlKey) {
            e.preventDefault();
            document.getElementById('locationSearch')?.focus();
        }
    });
});
</script>
{% endblock %}
